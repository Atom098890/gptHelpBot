name: Deploy Telegram Bot

on:
  push:
    branches:
      - main  # Запуск workflow при пуше в ветку master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Клонирование репозитория
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Установка SSH-соединения
    - name: Set up SSH connection
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.bothelp }}

    # 3. Копирование кода на сервер
    - name: Upload code to VPS
      run: |
        scp -o StrictHostKeyChecking=no -r . atom@89.116.34.119:/home/atom/gptHelpBot

    # 4. Сборка Docker-образа на сервере
    - name: Build and run Docker container on VPS
      run: |
        ssh -o StrictHostKeyChecking=no atom@89.116.34.119 "
          cd /home/atom/gptHelpBot &&
          docker build -t bothelp . &&
          docker stop bothelp || true &&
          docker rm bothelp || true &&
          docker run -d \
            --name bothelp \
            -e TOKEN_BOT=${{ secrets.TOKEN_BOT }} \
            -e TOKEN_AI=${{ secrets.TOKEN_AI }} \
            -e USERS=${{ secrets.USERS }} \
            -p 3000:3000 helpbot
        "
